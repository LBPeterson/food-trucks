<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="A layout example that shows off a responsive product landing page.">
  <title>food-trucks</title>
  <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.6.0/pure-min.css">

  <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css" />
  <script src="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>

  <!--[if lte IE 8]>
      <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.6.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
      <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.6.0/grids-responsive-min.css">
  <!--<![endif]-->
  <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css">
      <!--[if lte IE 8]>
          <link rel="stylesheet" href="css/layouts/marketing-old-ie.css">
      <![endif]-->
      <!--[if gt IE 8]><!-->
          <link rel="stylesheet" href="css/layouts/marketing.css">
      <!--<![endif]-->
</head>
<body>
  <!--<div class="header">
      <div class="home-menu pure-menu pure-menu-horizontal pure-menu-fixed">
          <a class="pure-menu-heading" href="">Food Trucks</a>
      </div>
  </div>-->

  <div id="map" class="splash-container"></div>

  <div class="content-wrapper">
      <div class="ribbon l-box-lrg pure-g">
          <div class="pure-u-1 pure-u-md-1-2 pure-u-lg-3-5">

              <h2 class="content-head content-head-ribbon">Find your local food trucks &darr;</h2>

              <p>
                  Trucks will be listed here in order of distance.
              </p>
              <table>
                <tr>
                  <th>Name</th>
                  <th>Type</th>
                  <th>Start Time</th>
                  <th>End Time</th>
                  <th>Latitude</th>
                  <th>Longitude</th>
                </tr>
                {{#each trucks}}
                  {{> truck}}
                {{/each}}
              </table>
          </div>
      </div>

      <div class="content">
          <h2 class="content-head is-center">{{> loginButtons}} to add your own truck</h2>

          <div class="pure-g">
              <div class="l-box-lrg pure-u-1 pure-u-md-2-5">
                  <form id="addNew" class="pure-form pure-form-stacked">
                      <label for="name">Name</label>
                      <input id="name" name="name" type="text" placeholder="Name" required>

                      <label for="type">Type of Food</label>
                      <input id="type" name="type" type="text" placeholder="Type of Food" required>

                      <label for="startTime">Start Time</label>
                      <input id="startTime" name="startTime" type="time" required>

                      <label for="endTime">End Time</label>
                      <input id="endTime" name="endTime" type="time" required>

                      <br><h3 class="is-center">Click on the map to select location</h3>

                      <label for="lat">Latitude</label>
                      <input id="lat" name="lat" type="text" required>

                      <label for="long">Longitude</label>
                      <input id="long" name="long" type="text" required>

                      {{#if currentUser}}
                        <input type="submit">
                      {{else}}
                        <h3 class="is-center">Login to submit</h3>
                      {{/if}}
                  </form>
              </div>

              <div class="l-box-lrg pure-u-1 pure-u-md-3-5">
                  <h4>About</h4>
                  <p>
                      This is a site dedicated to finding food trucks in your area.
                      It is mainly proof of concept for now, and unlikely to ever see
                      production.
                  </p>

                  <h4>Credits</h4>
                  <p>
                      <img src="http://www.meteor.com/meteor-logo.png" style="width:100%; max-width:300px; margin:auto; display: block;"/>
                      <img src="http://leafletjs.com/docs/images/logo.png" style="width:100%; max-width:300px; margin:auto; display: block;"/>
                      <h3 class="is-center">&copy; <a href="http://lukenotomatoes.github.io">Luke Peterson</a> 2015</h3>
                  </p>
              </div>
          </div>

      </div>

  </div>
  <div data-params='{"trucks":[{{#each markers}}{{> marker}}{{/each}}[]]}' id="TEST"></div>
  <script>
    var map;
    var marker;

    var locations = [
      {{#each markers}}
        {{> marker}}
      {{/each}}
      []
    ];
    console.log("inline");


    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(success, error);
    } else {
      error();
    }

    function addLayer(){
      L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
  			    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
  		}).addTo(map);
      console.log("addlayer");
    }
    function addMarkers() {
      map.on('click', function(e) {
        document.getElementById("lat").value = e.latlng.lat;
        document.getElementById("long").value = e.latlng.lng;
        if(typeof(marker)==='undefined')
          {
            marker = new L.marker(e.latlng);
            marker.addTo(map);
          } else {
            marker.setLatLng(e.latlng);
          }
      });
      console.log("addclick");

      json = document.getElementById("TEST").dataset.params;
      obj = JSON.parse(json);
      loc = obj.trucks;
      for (var i = 0; i &lt; (loc.length)-1; i++) {
        var text = loc[i][0].name+"<br />"+
                    loc[i][0].type+"<br />" +
                    "Open: "+loc[i][0].open +" to "+loc[i][0].close;
        var location = new L.marker([loc[i][0].lat,loc[i][0].long])
          .bindPopup(text)
          .addTo(map);
      }
      console.log("addmarker");
    }

    function success(position) {
      map = L.map('map').setView([position.coords.latitude, position.coords.longitude], 16);
      addLayer();
    }
    function error() {
      map = L.map('map').setView([44.9778, -93.2650], 12);
      addLayer();
    }

  </script>
</body>

<template name="truck">
  <tr>
    <td>{{name}}</td>
    <td>{{type}}</td>
    <td>{{start}}</td>
    <td>{{end}}</td>
    <td>{{lat}}</td>
    <td>{{long}}</td>
  </tr>
</template>
<template name="marker">
  [{"name":"{{name}}", "type":"{{type}}", "open":"{{start}}",
    "close":"{{end}}", "lat":{{lat}}, "long":{{long}} }],
</template>
<!-- TODOS
  Isolate database

  display/load only sites within 5 miles of center of map
  markers & popups on map
  delete old db entries
-->
